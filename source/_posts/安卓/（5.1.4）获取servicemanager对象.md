---
title: 获取ServiceManager对象
categories:
- [Android,Framework内核解析,IPC Binder机制]
---

# 获取ServiceManager对象

系统服务向servicemanager注册或者我们应用向servicemanager去获取系统服务时，都需要先获取 servicemanager的代理对象，那么我们这个视频就来介绍，如何获取 servicemanager的代理对象。
下面我们以AMS注册为例，在 systemserver 启动时，就会调用 AMS 的 setSystemProcess 方法，AMS就是通过该方法向servicemanager注册的。如果对 systemserver启动来不了解的同学，可以先去学习 systemserver 的启动流程。

```java
// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
public void setSystemProcess() {
    ... ... 
    // 将 AMS 注册到 servicemanager 中
    ServiceManager.addService(Context.ACTIVITY_SERVICE, this, /* allowIsolated= */ true,
    ... ...
}
```

```java
// frameworks/base/core/java/android/os/ServiceManager.java
public static void addService(String name, IBinder service, boolean allowIsolated,
            int dumpPriority) {
    getIServiceManager().addService(name, service, allowIsolated, dumpPriority);
    ... ...
}
```

其中 getIServiceManager 方法就是获取 servicemanager 的代理对象，也是我们这节课要分析的，addService 方法我们后续再分析。

## 1.getIServiceManager

```java
// frameworks/base/core/java/android/os/ServiceManager.java
private static IServiceManager getIServiceManager() {
    ... ...
    sServiceManager = ServiceManagerNative
                .asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));
    ... ...
}
```

ServiceManagerNative.asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));这个方法我们又需要分为两块分析，一个是方法体，一个是参数，如下：

1.  ServiceManagerNative.asInterface 是如何返回 servicemanager 的代理对象的
2.  Binder.allowBlocking(BinderInternal.getContextObject()) 这个方法参数到底是什么呢？

我们首先分析方法的参数到底是什么？再来分析方法体。

## 2.Binder.allowBlocking(BinderInternal.getContextObject())

Binder.allowBlocking 这个方法很简单，就是返回它的参数，所以Binder.allowBlocking(BinderInternal.getContextObject())具体返回什么，就只需要看 BinderInternal.getContextObject() 就行了。
BinderInternal.getContextObject() 实际是一个 native 方法，所以我们直接找到实际方法，如下:

```java
// frameworks/base/core/jni/android_util_Binder.cpp
static jobject android_os_BinderInternal_getContextObject(JNIEnv* env, jobject clazz)
{
    // 通过 ProcessState 的方法，创建 BpBinder 对象，并返回
    sp<IBinder> b = ProcessState::self()->getContextObject(NULL);
    // 创建 BinderProxy对象并返回，并将 BinderProxy 和 BpBinder 绑定
    return javaObjectForIBinder(env, b);
}
```

### 2-1.ProcessState::self()->getContextObject

我们先来分析 ProcessState::self()->getContextObject 方法。

```java
// frameworks/native/libs/binder/ProcessState.cpp
sp<IBinder> ProcessState::getContextObject(const sp<IBinder>& /*caller*/)
{
    // 获取 handle 为 0 的代理对象
    sp<IBinder> context = getStrongProxyForHandle(0);
    ... ...
    return context;
}
```

    sp<IBinder> ProcessState::getStrongProxyForHandle(int32_t handle)
    {
        ... ...
        b = BpBinder::create(handle);
        ... ...
    }

这个地方我们需要注意，创建 BpBinder对象时，传入的handle为0，就像门牌号一样，这个是规定的，为0 就表示找的是 servicemanager 的代理对象。

### 2-2.javaObjectForIBinder

```java
// frameworks/base/core/jni/android_util_Binder.cpp
jobject javaObjectForIBinder(JNIEnv* env, const sp<IBinder>& val)
{
    ... ...
    // 实际就是执行 BinderProxy的 getInstance方法
    jobject object = env->CallStaticObjectMethod(gBinderProxyOffsets.mClass,
            gBinderProxyOffsets.mGetInstance, (jlong) nativeData, (jlong) val.get());
    ... ...
    return object;
}
```

```java
// frameworks/base/core/java/android/os/BinderProxy.java
private static BinderProxy getInstance(long nativeData, long iBinder) {
    ... ...
    // 创建 BinderProxy 对象
    result = new BinderProxy(nativeData);
    ... ...
    // 将 BinderProxy 和 iBinder 绑定，iBinder实际就是 BpBinder
    sProxyMap.set(iBinder, result);
    ... ...
    // 返回 BinderProxy
    return result;
}
```

### 2-3.总结

通过分析可知，Binder.allowBlocking(BinderInternal.getContextObject()) 实际就是创建了 BpBinder 和 BinderProxy，并将二者关联，然后返回 BinderProxy 对象。

## 3.ServiceManagerNative.asInterface

我们再来分析 ServiceManagerNative.asInterface 方法：

```java
// frameworks/base/core/java/android/os/ServiceManagerNative.java
public static IServiceManager asInterface(IBinder obj) {
    ... ...
    // 返回 ServiceManagerProxy 对象，obj 为 BinderProxy 对象
    return new ServiceManagerProxy(obj);
}
```

到这儿我们就拿到了每一个层级的 servicemanager 的代理对象，如下图：
![77485381.png](https://lingzhiwen.github.io/images/%E8%8E%B7%E5%8F%96servicemanager%E5%AF%B9%E8%B1%A1_files/77485381.png)
应用层为：ServiceManagerProxy
Framework层为：BinderProxy
native层为：BpBinder
内核层代理为：binder\_ref 结构体
内核层实体为：binder\_node 结构体
